<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Holiday Hub</title>
    <link rel="stylesheet" href="styles/theme.css" />
  </head>
  <body>
    <a class="skip-link" href="#greetings">Skip to content</a>
    <header class="hero">
      <div class="parallax-scene" aria-hidden="true">
        <div class="sky layer" data-depth="0.1"></div>
        <div class="stars layer" data-depth="0.12"></div>
        <div class="hills layer" data-depth="0.2"></div>
        <div class="ribbon layer" data-depth="0.35"></div>
        <div class="foreground layer" data-depth="0.5"></div>
        <canvas id="snow-canvas" class="snow layer" data-depth="0.1"></canvas>
        <div class="snow-fallback" hidden>
          <div class="flake"></div>
          <div class="flake"></div>
          <div class="flake"></div>
          <div class="flake"></div>
          <div class="flake"></div>
        </div>
        <div class="bottle-3d" role="presentation" aria-hidden="true">
          <div class="bottle-body">
            <div class="bottle-label">Coca-Cola</div>
            <div class="bottle-cap"></div>
          </div>
        </div>
      </div>

      <div class="container content">
        <p class="badge">Holiday lounge</p>
        <h1>Season's greetings</h1>
        <p>
          Gather around the digital fireplace for heartfelt cards, cozy
          mini-games, and a cheerful guestbook to share the joy.
        </p>
        <div class="actions">
          <a class="btn glow-accent" href="#games">Play mini-games</a>
          <a class="btn secondary" href="#guestbook">Sign the guestbook</a>
        </div>
      </div>
    </header>

    <main>
      <section class="section" id="greetings">
        <div class="container">
          <h2 class="section-title">Festive greetings</h2>
          <p class="section-subtitle">
            Swipe through cards and warm wishes from friends everywhere.
          </p>
          <div class="carousel-shell">
            <div class="carousel-toolbar frosted-panel" aria-label="Carousel settings">
              <div class="custom-card">
                <h3 class="card-title">Personalize a card</h3>
                <label class="sr-only" for="custom-name">Sender name</label>
                <input
                  id="custom-name"
                  name="custom-name"
                  type="text"
                  placeholder="Your name"
                  autocomplete="name"
                />
                <label class="sr-only" for="custom-message">Message</label>
                <textarea
                  id="custom-message"
                  name="custom-message"
                  rows="2"
                  placeholder="Your cozy wish"
                ></textarea>
                <button class="btn secondary" id="apply-card" type="button">
                  Update my card
                </button>
              </div>
              <div class="carousel-actions" aria-label="Playback and navigation">
                <div class="toggle-group">
                  <label class="toggle" for="chime-toggle">
                    <input type="checkbox" id="chime-toggle" checked />
                    <span>Gentle chime on slide change</span>
                  </label>
                  <p class="hint" id="preference-hint"></p>
                </div>
                <div class="nav-buttons">
                  <button class="btn tertiary" id="prev-slide" type="button" aria-label="Previous card">
                    ◀ Prev
                  </button>
                  <button class="btn tertiary" id="play-toggle" type="button" aria-pressed="true">
                    Pause autoplay
                  </button>
                  <button class="btn tertiary" id="next-slide" type="button" aria-label="Next card">
                    Next ▶
                  </button>
                </div>
              </div>
            </div>

            <div class="carousel" aria-label="Holiday greeting cards">
              <div class="carousel-track" role="list" tabindex="0">
                <article class="card frosted-panel active" role="listitem" aria-label="Snowy wishes" tabindex="0">
                  <div class="snow-corners" aria-hidden="true"></div>
                  <h3 class="card-title">Snowy wishes</h3>
                  <p class="card-meta">From Jamie in Oslo</p>
                  <p>
                    May your cocoa stay warm and your playlists stay merry all
                    season long.
                  </p>
                </article>
                <article class="card frosted-panel" role="listitem" aria-label="Candy cane cheer" tabindex="-1">
                  <div class="snow-corners" aria-hidden="true"></div>
                  <h3 class="card-title">Candy cane cheer</h3>
                  <p class="card-meta">From Priya in Toronto</p>
                  <p>
                    Here's to board games, bright lights, and laughter that echoes
                    past midnight.
                  </p>
                </article>
                <article class="card frosted-panel" role="listitem" aria-label="Starlit skies" tabindex="-1">
                  <div class="snow-corners" aria-hidden="true"></div>
                  <h3 class="card-title">Starlit skies</h3>
                  <p class="card-meta">From Mateo in Quito</p>
                  <p>
                    Wishing you crisp nights, cozy blankets, and memories worth
                    framing.
                  </p>
                </article>
                <article class="card frosted-panel" role="listitem" aria-label="Your custom card" tabindex="-1" id="custom-card">
                  <div class="snow-corners" aria-hidden="true"></div>
                  <h3 class="card-title" id="custom-title">Your name here</h3>
                  <p class="card-meta" id="custom-meta">Personal touch</p>
                  <p id="custom-body">Share a cozy wish and see it shine.</p>
                </article>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="ribbon-divider"><span>Holiday mini-games</span></div>

      <section class="section" id="games">
        <div class="container">
          <h2 class="section-title">Mini-games lounge</h2>
          <p class="section-subtitle">
            Quick rounds of festive fun while the cocoa cools.
          </p>
          <div class="games-grid">
            <article class="game-card glow-accent">
              <span class="badge">New</span>
              <h3>Snowball Shuffle</h3>
              <p>Match the falling snowballs before they pile up too high.</p>
              <a class="btn secondary" href="#">Launch</a>
            </article>
            <article class="game-card glow-accent">
              <span class="badge">Co-op</span>
              <h3>Gift Wrap Relay</h3>
              <p>
                Race a friend to wrap gifts with perfect corners and glossy
                ribbons.
              </p>
              <a class="btn secondary" href="#">Launch</a>
            </article>
            <article class="game-card glow-accent">
              <span class="badge">Chill</span>
              <h3>Fireplace Lo-Fi</h3>
              <p>
                Compose a cozy beat with bells, crackles, and sleigh chimes.
              </p>
              <a class="btn secondary" href="#">Launch</a>
            </article>
          </div>
        </div>
      </section>

      <section class="section" id="guestbook">
        <div class="container">
          <h2 class="section-title">Sign the guestbook</h2>
          <p class="section-subtitle">
            Leave a note for the hosts or greet fellow guests.
          </p>
          <div class="guestbook">
            <form class="frosted-panel">
              <label for="name">Name</label>
              <input
                id="name"
                name="name"
                type="text"
                placeholder="Your name"
              />
              <label for="message">Message</label>
              <textarea
                id="message"
                name="message"
                rows="4"
                placeholder="Share some holiday cheer"
              ></textarea>
              <button class="btn" type="submit">Send</button>
            </form>
            <div class="frosted-panel">
              <h3 class="card-title">Latest notes</h3>
              <p>
                <strong>Alex</strong>: Can't wait for the gingerbread showdown!
              </p>
              <p>
                <strong>Rin</strong>: Saving a spot by the fire for everyone.
              </p>
              <p><strong>Lee</strong>: This guestbook is the coziest corner.</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container">
        <p class="section-title footer-title">Share the joy</p>
        <p class="section-subtitle footer-subtitle">
          Spread this experience with friends.
        </p>
        <ul class="share-buttons" aria-label="Share this page">
          <li><a href="#">Share on X</a></li>
          <li><a href="#">Share on Instagram</a></li>
          <li><a href="#">Copy invite link</a></li>
        </ul>
      </div>
    </footer>

    <script>
      (() => {
        const track = document.querySelector('.carousel-track');
        const slides = Array.from(track?.children ?? []);
        const prevBtn = document.getElementById('prev-slide');
        const nextBtn = document.getElementById('next-slide');
        const playToggle = document.getElementById('play-toggle');
        const chimeToggle = document.getElementById('chime-toggle');
        const preferenceHint = document.getElementById('preference-hint');
        const customName = document.getElementById('custom-name');
        const customMessage = document.getElementById('custom-message');
        const customApply = document.getElementById('apply-card');
        const customCard = document.getElementById('custom-card');
        const customTitle = document.getElementById('custom-title');
        const customMeta = document.getElementById('custom-meta');
        const customBody = document.getElementById('custom-body');

        if (!track || slides.length === 0) return;

        let current = 0;
        let autoplay = true;
        let autoplayTimer;
        let isPointerDown = false;
        let startX = 0;
        let prefersMotionReduced = window.matchMedia('(prefers-reduced-motion: reduce)');
        let prefersDataReduced = window.matchMedia('(prefers-reduced-data: reduce)');
        let prefersAudioReduced = window.matchMedia('(prefers-reduced-transparency: reduce)');
        const isAudioRestricted = () =>
          prefersMotionReduced.matches || prefersDataReduced.matches || prefersAudioReduced.matches;

        const audioContext = window.AudioContext ? new AudioContext() : null;
        const playChime = () => {
          if (!audioContext || isAudioRestricted() || !chimeToggle.checked) return;
          if (audioContext.state === 'suspended') {
            audioContext.resume().catch(() => {});
          }

          const now = audioContext.currentTime;
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();

          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, now);
          osc.frequency.exponentialRampToValueAtTime(1760, now + 0.35);

          gain.gain.setValueAtTime(0.001, now);
          gain.gain.exponentialRampToValueAtTime(0.12, now + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);

          osc.connect(gain);
          gain.connect(audioContext.destination);

          osc.start(now);
          osc.stop(now + 0.7);
        };

        const announcePreference = () => {
          const hints = [];
          if (prefersMotionReduced.matches) hints.push('autoplay paused for reduced-motion preference');
          if (prefersDataReduced.matches) hints.push('audio muted to respect reduced-data');
          if (prefersAudioReduced.matches) hints.push('audio muted for reduced-transparency preference');
          preferenceHint.textContent = hints.join(' · ');
        };

        if (isAudioRestricted()) {
          chimeToggle.checked = false;
          chimeToggle.disabled = true;
        }

        if (prefersMotionReduced.matches) {
          autoplay = false;
          playToggle.textContent = 'Play autoplay';
          playToggle.setAttribute('aria-pressed', 'false');
        }

        announcePreference();

        const updateSlides = (focus = false) => {
          slides.forEach((slide, index) => {
            const isActive = index === current;
            slide.classList.toggle('active', isActive);
            slide.setAttribute('aria-hidden', !isActive);
            slide.setAttribute('tabindex', isActive ? '0' : '-1');
          });
          track.style.transform = `translateX(-${current * 100}%)`;

          if (focus) {
            slides[current].focus({ preventScroll: false });
          }

          playChime();
        };

        const goToSlide = (index, focus = false) => {
          current = (index + slides.length) % slides.length;
          updateSlides(focus);
          restartAutoplay();
        };

        const restartAutoplay = () => {
          clearInterval(autoplayTimer);
          if (!autoplay) return;
          autoplayTimer = setInterval(() => goToSlide(current + 1), 5500);
        };

        const toggleAutoplay = () => {
          autoplay = !autoplay;
          playToggle.setAttribute('aria-pressed', String(autoplay));
          playToggle.textContent = autoplay ? 'Pause autoplay' : 'Play autoplay';
          if (autoplay && !prefersMotionReduced.matches) {
            restartAutoplay();
          } else {
            clearInterval(autoplayTimer);
          }
        };

        const handlePointerUp = (clientX) => {
          const delta = clientX - startX;
          if (Math.abs(delta) > 40) {
            goToSlide(delta < 0 ? current + 1 : current - 1);
          }
          isPointerDown = false;
        };

        nextBtn?.addEventListener('click', () => goToSlide(current + 1, true));
        prevBtn?.addEventListener('click', () => goToSlide(current - 1, true));
        playToggle?.addEventListener('click', toggleAutoplay);

        track.addEventListener('pointerdown', (event) => {
          isPointerDown = true;
          startX = event.clientX;
        });

        track.addEventListener('pointermove', (event) => {
          if (!isPointerDown) return;
          if (event.pointerType === 'touch') {
            event.preventDefault();
          }
        });

        track.addEventListener('pointerup', (event) => handlePointerUp(event.clientX));
        track.addEventListener('pointercancel', () => (isPointerDown = false));

        track.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowRight') {
            event.preventDefault();
            goToSlide(current + 1, true);
          }
          if (event.key === 'ArrowLeft') {
            event.preventDefault();
            goToSlide(current - 1, true);
          }
        });

        customApply?.addEventListener('click', () => {
          const name = (customName?.value || 'Your name here').trim();
          const message = (customMessage?.value || 'Share a cozy wish and see it shine.').trim();
          customTitle.textContent = name || 'Your name here';
          customMeta.textContent = name ? `From ${name}` : 'Personal touch';
          customBody.textContent = message;
          customCard?.setAttribute('aria-label', `${name || 'Your'} custom card`);
          goToSlide(slides.indexOf(customCard), true);
        });

        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            clearInterval(autoplayTimer);
          } else if (autoplay) {
            restartAutoplay();
          }
        });

        prefersMotionReduced.addEventListener('change', (event) => {
          autoplay = !event.matches;
          playToggle.setAttribute('aria-pressed', String(autoplay));
          playToggle.textContent = autoplay ? 'Pause autoplay' : 'Play autoplay';
          if (autoplay) restartAutoplay();
          else clearInterval(autoplayTimer);
          announcePreference();
        });

        prefersDataReduced.addEventListener('change', () => {
          if (prefersDataReduced.matches || isAudioRestricted()) {
            chimeToggle.checked = false;
            chimeToggle.disabled = true;
          } else {
            chimeToggle.disabled = false;
          }
          announcePreference();
        });

        prefersAudioReduced.addEventListener('change', () => {
          if (prefersAudioReduced.matches || isAudioRestricted()) {
            chimeToggle.checked = false;
            chimeToggle.disabled = true;
          } else {
            chimeToggle.disabled = false;
          }
          announcePreference();
        });

        updateSlides();
        if (autoplay) restartAutoplay();
      })();
      const prefersReducedMotion = window.matchMedia(
        "(prefers-reduced-motion: reduce)"
      );

      const scene = document.querySelector(".parallax-scene");
      const layers = Array.from(scene?.querySelectorAll(".layer") || []);

      function applyParallax() {
        if (!scene || prefersReducedMotion.matches) return;

        const rect = scene.getBoundingClientRect();
        const centerY = rect.top + rect.height / 2;
        const scrollY = window.innerHeight / 2 - centerY;

        layers.forEach((layer) => {
          const depth = Number(layer.dataset.depth || 0);
          const translateY = scrollY * depth * 0.35;
          layer.style.transform = `translate3d(0, ${translateY}px, 0)`;
        });

        requestAnimationFrame(applyParallax);
      }

      const snowCanvas = document.getElementById("snow-canvas");
      const snowFallback = document.querySelector(".snow-fallback");

      function supportsWebGL() {
        try {
          const canvas = document.createElement("canvas");
          return !!(
            window.WebGLRenderingContext &&
            (canvas.getContext("webgl") || canvas.getContext("experimental-webgl"))
          );
        } catch (err) {
          return false;
        }
      }

      function initSnowCanvas() {
        if (!snowCanvas || prefersReducedMotion.matches || !supportsWebGL()) {
          snowCanvas?.setAttribute("hidden", "true");
          snowFallback?.removeAttribute("hidden");
          return initFallbackSnow();
        }

        const ctx = snowCanvas.getContext("2d");
        const flakes = Array.from({ length: 180 }, () => ({
          x: Math.random() * window.innerWidth,
          y: Math.random() * window.innerHeight,
          r: Math.random() * 3 + 1,
          s: Math.random() * 0.6 + 0.4,
        }));

        function resize() {
          snowCanvas.width = window.innerWidth;
          snowCanvas.height = scene.offsetHeight + 200;
        }

        function draw() {
          ctx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
          ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
          flakes.forEach((flake) => {
            ctx.beginPath();
            ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
            ctx.fill();

            flake.y += flake.s * 3;
            flake.x += Math.sin(flake.y * 0.01) * 0.6;

            if (flake.y > snowCanvas.height) {
              flake.y = -flake.r;
              flake.x = Math.random() * snowCanvas.width;
            }
          });

          requestAnimationFrame(draw);
        }

        window.addEventListener("resize", resize);
        resize();
        draw();
      }

      function initFallbackSnow() {
        if (!snowFallback) return;
        snowFallback.querySelectorAll(".flake").forEach((flake, index) => {
          flake.style.setProperty("--delay", `${index * 1.2}s`);
        });
      }

      function initBottle() {
        const bottle = document.querySelector(".bottle-3d");
        if (!bottle) return;
        bottle.classList.toggle("reduced", prefersReducedMotion.matches);
      }

      window.addEventListener("scroll", () => {
        if (!prefersReducedMotion.matches) {
          requestAnimationFrame(applyParallax);
        }
      });

      prefersReducedMotion.addEventListener("change", () => {
        if (prefersReducedMotion.matches) {
          layers.forEach((layer) => (layer.style.transform = ""));
        }
        initBottle();
        initSnowCanvas();
      });

      initBottle();
      initSnowCanvas();
      requestAnimationFrame(applyParallax);
    </script>
  </body>
</html>
